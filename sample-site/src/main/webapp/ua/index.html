<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/0.16.1/css/semantic.min.css"
          type="text/css"/>
    <link rel='stylesheet' type='text/css' href='http://fonts.googleapis.com/css?family=Open+Sans'/>
    <style>
        * { font-family: 'Open Sans', sans-serif; }
        .ui.thumbnails>.item { cursor: pointer; }
        /*.ui.variations, .ui.sizes { margin-bottom: 20px; }*/
        .ui.connected.variations>.row>.item { width: 40px; min-height: 30px; text-align: center; vertical-align: middle; margin: 4px; padding: 1px; font-size: 0.75em; }
        .ui.connected.variations>.row>.item>.content { padding: 1px; }
        .ui.connected.variations>.row>.item>.content>img { width: 35px; }
        /*.ui.variations>.row>.item:last-child,.ui.sizes>.item:last-child { margin-bottom: 20px; }*/
        .ui.connected.sizes>.row>.item { width: 45px; min-height: 45px; text-align: center; vertical-align: middle; margin: 4px; font-size: 0.75em; }
        .ui.price.tags>.list_price { font-weight: 600; }
        .ui.price.tags>.base_price { text-decoration: line-through; font-size: 0.8em; color: red; }
        .description.tags { font-size: 0.8em; color: gray; margin-bottom: 20px; }
        .ui.basic.segment.main { margin-left: auto; margin-right: auto; }
        .ui.body { width: 1280px; margin-left: auto; margin-right:auto; }
    </style>
    <title>:: the store ::</title>
</head>
<body>
<div class="ui raised segment">
    <div class="ui inverted menu">
        <a class="item">
            <i class="home icon"></i> Home
        </a>
        <div class="ui dropdown item">
            Men
        </div>
        <a class="item">
            Women
        </a>
        <div class="ui dropdown item">
            Goodies
        </div>

        <div class="right menu">
            <div class="ui dropdown item">
                <i class="icon globe"></i>
                <div class="ui black tiny label locale_holder">en_US</div>
                <div class="menu locale_picker">
                    <a class="item">en_US</a>
                    <a class="item">en_GB</a>
                    <a class="item">en_IE</a>
                    <a class="item">ja_JP</a>
                    <a class="item">hi_IN</a>
                </div>
            </div>
            <div class="item">
                <div class="ui icon input">
                    <input type="text" placeholder="Search..." class="searcher">
                    <i class="search link icon"></i>
                </div>
            </div>
            <a class="item">
                <i class="user icon"></i>
            </a>
            <a class="item">
                <i class="cart icon"></i>
            </a>
        </div>

    </div>

    <div class="ui basic segment">

        <div class="ui small breadcrumb">
            <a class="section"><i class="circle left icon"></i> Back</a>
            <div class="divider">  &#124;</div>
            <a class="section">Home</a>
        </div>

        <div class="ui grid body">
            <div class="ui active dimmer"><div class="ui large text loader">Loading</div></div>
            <div class="three wide column">
                <div class="ui list thumbnails">

                </div>
            </div>
            <div class="seven wide column">
                <div class="ui segment basic main">
                    <h3 class="ui black header">
                    </h3>
                    <div class="ui price tags">
                        <span class="list_price"></span>
                        <span class="base_price"></span>
                    </div>
                    <div class="ui image pdp">
                        <a class="ui left red corner label">
                            <div class="text">NEW</div>
                        </a>
                        <img src=""/>
                    </div>
                    <div >
                        <div class="description tags">
                        </div>
                        <div class="ui small stars">
                            <i class="icon star"></i>
                            <i class="icon star"></i>
                            <i class="icon star"></i>
                            <i class="icon empty star"></i>
                            <i class="icon empty star"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="five wide column">
                <div class="ui basic segment">
                    <div class="ui form">
                        <div class="fields">
                            <div class="fifteen wide field">
                                <div class="ui connected items variations">
                                </div>
                            </div>
                        </div>
                        <div class="fields sizes">
                            <div class="fifteen wide field">
                                <div class="ui connected items sizes">
                                    <div class="row">
                                        <div class="item"><div class="content">SM</div></div>
                                        <div class="item"><div class="content">MD</div></div>
                                        <div class="item"><div class="content">LG</div></div>
                                        <div class="item"><div class="content">XL</div></div>
                                        <div class="item"><div class="content">XXL</div></div>
                                        <div class="item"><div class="content">3XL</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="fields">
                            <div class="ten wide field">
                                <div class="ui fluid selection tiny dropdown">
                                    <input type="hidden" name="qty">
                                    <div class="default text">Qty</div>
                                    <i class="dropdown icon"></i>
                                    <div class="menu ui transition hidden">
                                        <div class="item" data-value="male">1</div>
                                        <div class="item" data-value="male">2</div>
                                        <div class="item" data-value="male">3</div>
                                        <div class="item" data-value="male">4</div>
                                        <div class="item" data-value="male">5</div>
                                        <div class="item" data-value="male">6</div>
                                        <div class="item" data-value="male">7</div>
                                        <div class="item" data-value="male">8</div>
                                        <div class="item" data-value="male">9</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="fields">
                            <div class="ten wide field">
                                <div class="ui fluid facebook submit button medium">
                                    <span style="font-size: 0.8rem;">ADD TO CART</span> <i class="cart outline icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>


</div>
<script type="application/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore.js"></script>
<script type="application/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.js"></script>
<script type="application/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/0.16.1/javascript/semantic.js"></script>
<script type="application/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.4.13/d3.js"></script>
<script type="application/javascript">
    var data;
    var grouped;
    var thumbnails;
    var default_pid = 'underarmour_0000';

    $(document).ready(function() {
        $('.ui.dropdown').dropdown();
        $('.menu.locale_picker>.item').on('click', function() {
            $('.locale_holder').text($(this).text());
        });
        $('.menu.product_picker>.item').on('click', function() {
            var pid = $(this).attr('data-pid');
            var locale = $(this).attr('data-locale');
            $('.locale_holder').text(locale);
            searchProduct(pid);
        });

        $('.searcher').on('keypress', function(e) {
            if (e.which == 13) {
                $('.ui.grid>.ui.dimmer').addClass('active');
                searchProduct($(this).val());
            }
        });

        searchProduct(default_pid);
    });

    function prepareSample(sample) {
        return _.map(sample, function(prd) {
            prd.extendAttributes = _.reduce(prd, function(map, val, attr) { if (/ext_/.test(attr)) map[attr] = val;  return map; }, {});
            return prd;
        });
    }

    function prepareVariations() {
        thumbnails = _.groupBy(data, function(p) { return p.displayName + ':' + p.extendAttributes['ext_msPDPShortDescription'] + ':' + p.extendAttributes['ext_msPDPVariationLabelOverride']; });
        grouped = d3.nest()
                    .key(function(p) { return p.displayName + ':' + p.extendAttributes['ext_msPDPShortDescription'] + ':' + p.extendAttributes['ext_msPDPVariationLabelOverride']; })
                    .key(function(p) { return p.extendAttributes['ext_msSize']; })
                    .entries(data);
    }

    function searchProduct(pid) {
        $.ajax({
            type: "GET",
            url: '/pd/' + $('.locale_holder').text() + '/' + pid,
            statusCode : {
                404: function() {
                    $('.ui.grid>.ui.dimmer').removeClass('active');
                }
            }
        }).done(function(products) {
            if (products && products.length > 0) {
                data = products;
                prepareVariations();
                showProduct();
            } else {
                $('.ui.grid>.ui.dimmer').removeClass('active');
            }
        });
    }

    function showProduct() {
        $('.ui.breadcrumb').html('');
        $('.ui.breadcrumb')
                .append($('<a/>').addClass('section').append($('<i/>').addClass('circle left icon')).append(' Back')).append($('<div/>').addClass('divider').text('｜'))
                .append($('<a/>').addClass('section').append('Home')).append($('<div/>').addClass('divider').text(' /'));

        $('.fields.sizes').show();

        var categories = data[0].extendAttributes['ext_msCategory'];
        _.each(categories.split(','), function(cat, index, list) {
            $('.ui.breadcrumb').append($('<a/>').addClass('section').append(cat)).append($('<div/>').addClass('divider').text(' /'));
        });

        $('.ui.breadcrumb').append($('<a/>').addClass('action section').append(data[0].displayName));

        $('.ui.variations').html('');
        var row;
        _.each(grouped, function(pd, index, all) {
            var content = $('<div></div>').addClass('content').addClass('content').on('click', function(e) {
                displayVariation(index);
            });
            if (index % 7 == 0) {
                row = $('<div/>').addClass('row');
                $('.ui.variations').append(row);
            }
            row.append(
                $('<div></div>').addClass('item').append(content)
            );
            content.html($('<img>').attr('src', thumbnails[pd.key][0].extendAttributes['ext_msThumbnail'] ));

        });

        displayVariation(0);
        $('.ui.grid>.ui.dimmer').removeClass('active');
    }

    function displayVariation(vIdx) {
        var variation = grouped[vIdx];

        $('.ui.sizes').html('');
        var row;
        _.each(variation.values, function(pd, sIdx, all) {
            var content = $('<div></div>').addClass('content').addClass('content').on('click', function(e) {
                displayProduct(vIdx, sIdx);
            });
            if (sIdx % 7 == 0) {
                row = $('<div/>').addClass('row');
                $('.ui.sizes').append(row);
            }
            row.append(
                $('<div></div>').addClass('item').append(content)
            );
            content.html($('<span>' + pd.key + '</span>'));

        });

        displayProduct(vIdx, 0);
    }

    function displayProduct(vIdx, sIdx) {
        var pd = grouped[vIdx].values[sIdx].values[0];
        var attrs = pd.extendAttributes;

        $('h3.ui.header').html($('<span></span>').text(pd.displayName).append($('<div></div>').addClass('sub header').append($('<span>' + attrs['ext_msPDPShortDescription'] +  '</span>'))));

        $('.description.tags').text(pd['sku']);
        $('.ui.price>.base_price').text(attrs['ext_msMSRP']);
        $('.ui.price>.list_price').text(attrs['ext_msListPrice']);

        $('.ui.thumbnails').html('');
        _.each(_.sortBy(_.filter(_.keys(attrs), function(name) { return /ext_PDPThumbnailImage/.test(name); })), function(imgKey) {
            var pindx = imgKey.substr('ext_PDPThumbnailImage'.length);
            $('.ui.thumbnails').append(
                    $('<div></div>').addClass('item').append(
                            $('<img/>').addClass('ui image right floated').attr('src', attrs[imgKey]))
                            .on('click', function(e) {
                                $('.ui.pdp>img').attr('src', attrs['ext_PDPImageLarge' + pindx]);
                                $('.ui.pdp>.ui.label>div.text').text(attrs['ext_msSize']);
                            }));
        });

        $('.ui.pdp>img').attr('src', attrs['ext_PDPImageLarge' + 1]);
        $('.ui.pdp>.ui.label>div.text').text(attrs['ext_msSize']);
    }

</script>
</body>
</html>